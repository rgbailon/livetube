<!DOCTYPE html>
<html lang="en" prefix="og: https://ogp.me/ns#">
<head>
    <!-- Primary Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>LiveTube - Watch Live Streams | Free Live Video Streaming Platform</title>
    <meta name="title" content="LiveTube - Watch Live Streams | Free Live Video Streaming Platform">
    <meta name="description" content="Watch live streams from around the world on LiveTube. Discover live gaming, music, sports, news, entertainment and more. Real-time live video streaming platform with auto-updating content.">
    <meta name="keywords" content="live stream, live video, streaming, watch live, live gaming, live music, live sports, live news, live entertainment, youtube live, twitch alternative, live broadcast, real-time video, live tv, streaming platform">
    <meta name="author" content="LiveTube">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <meta name="bingbot" content="index, follow">
    <meta name="language" content="English">
    <meta name="revisit-after" content="1 days">
    <meta name="rating" content="general">
    <meta name="distribution" content="global">
    <link rel="canonical" href="https://livetube.com/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://livetube.com/">
    <meta property="og:title" content="LiveTube - Watch Live Streams | Free Live Video Streaming Platform">
    <meta property="og:description" content="Watch live streams from around the world. Discover live gaming, music, sports, news, entertainment and more. Real-time live video streaming.">
    <meta property="og:image" content="https://livetube.com/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="LiveTube - Live Streaming Platform">
    <meta property="og:site_name" content="LiveTube">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://livetube.com/">
    <meta name="twitter:title" content="LiveTube - Watch Live Streams | Free Live Video Streaming Platform">
    <meta name="twitter:description" content="Watch live streams from around the world. Discover live gaming, music, sports, news, entertainment and more.">
    <meta name="twitter:image" content="https://livetube.com/twitter-image.jpg">
    <meta name="twitter:site" content="@livetube">
    <meta name="twitter:creator" content="@livetube">
    
    <!-- Apple Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LiveTube">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- Microsoft Meta Tags -->
    <meta name="msapplication-TileColor" content="#ff0000">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="theme-color" content="#1f2937">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ff0000'><path d='M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z'/></svg>">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://www.googleapis.com">
    <link rel="preconnect" href="https://www.youtube.com">
    <link rel="preconnect" href="https://i.ytimg.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.googleapis.com">
    <link rel="dns-prefetch" href="https://www.youtube.com">
    
    <!-- Structured Data / JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "LiveTube",
        "alternateName": ["Live Tube", "LiveTube Streaming"],
        "url": "https://livetube.com/",
        "description": "Watch live streams from around the world. Discover live gaming, music, sports, news, entertainment and more.",
        "potentialAction": {
            "@type": "SearchAction",
            "target": {
                "@type": "EntryPoint",
                "urlTemplate": "https://livetube.com/search?q={search_term_string}"
            },
            "query-input": "required name=search_term_string"
        },
        "publisher": {
            "@type": "Organization",
            "name": "LiveTube",
            "logo": {
                "@type": "ImageObject",
                "url": "https://livetube.com/logo.png",
                "width": 600,
                "height": 60
            }
        }
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "LiveTube",
        "url": "https://livetube.com/",
        "logo": "https://livetube.com/logo.png",
        "sameAs": [
            "https://twitter.com/livetube",
            "https://facebook.com/livetube",
            "https://instagram.com/livetube",
            "https://youtube.com/livetube"
        ],
        "contactPoint": {
            "@type": "ContactPoint",
            "contactType": "customer support",
            "availableLanguage": ["English"]
        }
    }
    </script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [{
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "https://livetube.com/"
        },{
            "@type": "ListItem",
            "position": 2,
            "name": "Live Streams",
            "item": "https://livetube.com/live"
        }]
    }
    </script>
    
    <!-- External Resources -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZQZZ8JCSRP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-ZQZZ8JCSRP');
    </script>
    <style>
        * { font-family: 'Roboto', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .categories-wrapper { user-select: none; }
        .scroll-btn { transition: opacity 0.3s, visibility 0.3s; }
        .live-badge { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .thumbnail-hover:hover .play-overlay { opacity: 1; }
        .play-overlay { opacity: 0; transition: opacity 0.3s; }
        .category-btn.active { background: #ff0000; color: white; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ff0000; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between gap-4 flex-wrap">
            <div class="flex items-center gap-2">
                <svg class="w-10 h-10 text-red-600" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
                </svg>
                <h1 class="text-xl font-bold text-red-500">LiveTube</h1>
                <span class="bg-red-600 text-xs px-2 py-1 rounded live-badge">LIVE</span>
            </div>
            
            <!-- Search Bar -->
            <div class="flex-1 max-w-2xl">
                <div class="flex">
                    <input type="text" id="searchInput" placeholder="Search live streams..." 
                        class="flex-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-l-full focus:outline-none focus:border-blue-500 text-white">
                    <button onclick="searchVideos()" class="px-6 py-2 bg-gray-700 border border-l-0 border-gray-600 rounded-r-full hover:bg-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- API & Refresh Status -->
            <div class="flex items-center gap-2 sm:gap-4">
                <button id="apiStatusBtn" onclick="openApiSettings()" class="hidden text-xs px-3 py-1.5 rounded-full flex items-center gap-1.5 cursor-pointer hover:opacity-80 transition" title="Click to manage API keys">
                    <span class="w-2 h-2 rounded-full"></span>
                    <span id="apiStatusText">API 1/1</span>
                    <svg class="w-3 h-3 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div id="refreshStatus" class="text-xs text-gray-400 hidden">
                    <span id="countdown">30</span>s
                </div>
            </div>
        </div>
    </header>

    <!-- API Key Modal -->
    <div id="apiModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-gray-800 rounded-xl p-8 max-w-lg w-full shadow-2xl my-8 relative">
            <!-- Close Button (only visible when already has keys and is editing) -->
            <button id="modalCloseBtn" onclick="closeApiModal()" class="hidden absolute top-4 right-4 p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full transition" title="Close">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="text-center mb-6">
                <svg class="w-16 h-16 text-red-600 mx-auto mb-4" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
                </svg>
                <h2 id="modalTitle" class="text-2xl font-bold mb-2">Welcome to LiveTube</h2>
                <p class="text-gray-400">Add your YouTube Data API v3 keys (supports multiple keys with auto-switching)</p>
            </div>
            
            <!-- API Keys List -->
            <div id="apiKeysList" class="mb-4 max-h-64 overflow-y-auto space-y-3 pr-1">
                <!-- Keys will be listed here -->
            </div>
            
            <!-- Add New Key -->
            <div class="flex gap-2 mb-4">
                <input type="text" id="apiKeyInput" placeholder="Enter a YouTube API Key" 
                    class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-red-500 text-white text-sm">
                <button onclick="addApiKey()" id="addKeyBtn" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition whitespace-nowrap flex items-center gap-2">
                    <span id="addKeyText">+ Add</span>
                    <svg id="addKeySpinner" class="w-4 h-4 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Validation Status -->
            <div id="validationStatus" class="hidden mb-4 p-3 rounded-lg text-sm flex items-center gap-2">
                <span id="validationIcon"></span>
                <span id="validationMessage"></span>
            </div>
            
            <!-- Key Count Info -->
            <div id="keyCountInfo" class="text-center text-sm text-gray-400 mb-2">
                <span id="keyCount">0</span> API key(s) added
                <span class="text-yellow-500 ml-2" id="quotaWarning" style="display: none;">‚Ä¢ Auto-switch on quota exceeded</span>
            </div>
            
            <!-- Total Quota Stats -->
            <div id="totalQuotaStats" class="text-center mb-2 p-2 bg-gray-700/50 rounded-lg">
                <div class="text-xs text-gray-400">
                    <span class="font-medium text-white">0</span> total units used today
                </div>
            </div>
            
            <!-- Quota Reset Info -->
            <div class="flex items-center justify-center gap-2 mb-4">
                <span class="text-xs text-gray-500">Quota resets daily at midnight PT</span>
                <button onclick="resetQuotaStats()" class="text-xs text-blue-400 hover:text-blue-300 underline" title="Reset quota tracking (for testing)">
                    Reset Stats
                </button>
            </div>
            
            <!-- Validate All Button -->
            <button onclick="validateAllKeys()" id="validateAllBtn" class="hidden w-full mb-3 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 text-white font-bold py-2 rounded-lg transition flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span id="validateAllText">Validate All Keys</span>
            </button>
            
            <!-- Start Button (for first time) -->
            <button onclick="startWithKeys()" id="startButton" disabled class="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white font-bold py-3 rounded-lg transition flex items-center justify-center gap-2">
                <span id="startButtonText">Start Watching Live</span>
                <svg id="startSpinner" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
            
            <!-- Done Button (for returning users editing keys) -->
            <button onclick="closeApiModal()" id="doneButton" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                <span>Done - Back to Streams</span>
            </button>
            
            <div class="mt-4 p-3 bg-gray-700/50 rounded-lg">
                <p class="text-xs text-gray-400 text-center mb-2">
                    üí° <strong>Pro Tip:</strong> Add multiple API keys to avoid quota limits. Keys auto-switch when one exceeds its quota.
                </p>
                <p class="text-xs text-gray-500 text-center">
                    Get your API key from <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-blue-400 hover:underline">Google Cloud Console</a>
                </p>
            </div>
        </div>
    </div>
    
    <!-- API Settings Button (shown after initial setup) -->
    <button id="apiSettingsBtn" onclick="openApiSettings()" class="hidden fixed bottom-4 right-4 z-40 px-4 py-3 bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-full shadow-lg transition flex items-center gap-2" title="Manage API Keys">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
        </svg>
        <span class="text-sm font-medium">API Keys</span>
    </button>

    <!-- Video Player Modal -->
    <div id="playerModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4 overflow-y-auto">
        <div class="w-full max-w-6xl my-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="playerTitle" class="text-xl font-bold truncate pr-4"></h3>
                <button onclick="closePlayer()" class="p-2 hover:bg-gray-700 rounded-full flex-shrink-0">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Video and Chat Container -->
            <div class="flex flex-col lg:flex-row gap-4">
                <!-- Video Section -->
                <div class="flex-1">
                    <div class="relative pt-[56.25%] bg-black rounded-xl overflow-hidden">
                        <iframe id="videoPlayer" class="absolute inset-0 w-full h-full" frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    
                    <!-- Video Info -->
                    <div id="playerInfo" class="mt-4 p-4 bg-gray-800 rounded-xl">
                        <div class="flex items-center gap-3 mb-3">
                            <img id="channelThumbnail" class="w-10 h-10 rounded-full" src="" alt="">
                            <div class="flex-1">
                                <p id="channelName" class="font-medium"></p>
                                <p id="viewerCount" class="text-sm text-gray-400"></p>
                            </div>
                            <a id="watchOnYoutube" href="#" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium transition">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
                                </svg>
                                Watch on YouTube
                            </a>
                        </div>
                        <p id="videoDescription" class="text-sm text-gray-300 line-clamp-3"></p>
                    </div>
                </div>
                
                <!-- Live Chat Section -->
                <div class="lg:w-96 flex flex-col">
                    <div class="bg-gray-800 rounded-xl overflow-hidden flex flex-col h-[400px] lg:h-[500px]">
                        <!-- Chat Header -->
                        <div class="flex items-center justify-between px-4 py-3 bg-gray-700 border-b border-gray-600">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                                </svg>
                                <span class="font-medium">Live Chat</span>
                                <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                            </div>
                            <button onclick="toggleChat()" id="chatToggleBtn" class="text-xs px-2 py-1 bg-gray-600 hover:bg-gray-500 rounded transition">
                                Hide
                            </button>
                        </div>
                        
                        <!-- Chat iframe -->
                        <div id="chatContainer" class="flex-1 relative">
                            <iframe id="liveChatFrame" class="absolute inset-0 w-full h-full bg-gray-900" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
                            
                            <!-- Chat Unavailable Message -->
                            <div id="chatUnavailable" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-gray-900 text-center p-4">
                                <svg class="w-12 h-12 text-gray-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                <p class="text-gray-400 text-sm mb-2">Live chat not available</p>
                                <p class="text-gray-500 text-xs">Chat may be disabled for this stream</p>
                                <a id="chatYoutubeLink" href="#" target="_blank" class="mt-3 text-blue-400 hover:text-blue-300 text-sm flex items-center gap-1">
                                    Open chat on YouTube
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                        
                        <!-- Chat Footer -->
                        <div class="px-4 py-2 bg-gray-700 border-t border-gray-600 text-xs text-gray-400 text-center">
                            Chat provided by YouTube
                        </div>
                    </div>
                    
                    <!-- Chat Info -->
                    <div class="mt-3 p-3 bg-gray-800/50 rounded-lg text-xs text-gray-500 text-center">
                        üí¨ Sign in to YouTube to participate in chat
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Categories -->
        <div class="mb-6 relative categories-wrapper">
            <!-- Left Fade Gradient -->
            <div id="leftFade" class="absolute left-0 top-0 bottom-0 w-12 bg-gradient-to-r from-gray-900 to-transparent z-[5] pointer-events-none opacity-0 transition-opacity duration-300"></div>
            
            <!-- Left Arrow -->
            <button onclick="scrollCategories(-300)" id="scrollLeftBtn" 
                class="scroll-btn absolute left-0 top-1/2 -translate-y-1/2 z-10 w-10 h-10 bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-full shadow-lg flex items-center justify-center opacity-0 invisible">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            
            <!-- Categories Container -->
            <div class="flex gap-2 overflow-x-auto hide-scrollbar py-2 px-1 scroll-smooth" id="categoriesContainer">
                <button onclick="selectCategory(null)" class="category-btn active whitespace-nowrap px-4 py-2 bg-gray-700 rounded-full text-sm hover:bg-gray-600 transition flex-shrink-0">
                    üî¥ All Live
                </button>
            </div>
            
            <!-- Right Fade Gradient -->
            <div id="rightFade" class="absolute right-0 top-0 bottom-0 w-12 bg-gradient-to-l from-gray-900 to-transparent z-[5] pointer-events-none transition-opacity duration-300"></div>
            
            <!-- Right Arrow -->
            <button onclick="scrollCategories(300)" id="scrollRightBtn" 
                class="scroll-btn absolute right-0 top-1/2 -translate-y-1/2 z-10 w-10 h-10 bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-full shadow-lg flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        </div>

        <!-- Current Category Header -->
        <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <h2 id="categoryTitle" class="text-xl font-bold">All Live Streams</h2>
                <span id="liveCount" class="bg-red-600 text-white text-xs px-2 py-1 rounded-full hidden">0 live</span>
            </div>
            <button onclick="loadLiveStreams()" class="flex items-center gap-2 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Refresh
            </button>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden flex flex-col justify-center items-center py-20">
            <div class="loader mb-4"></div>
            <p id="loadingText" class="text-gray-400 text-sm">Searching for live streams...</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-900/50 border border-red-500 rounded-xl p-6 text-center">
            <p class="text-red-400"></p>
        </div>

        <!-- No Results -->
        <div id="noResults" class="hidden text-center py-20">
            <svg class="w-20 h-20 mx-auto text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            <p class="text-gray-400 text-xl">No live streams found</p>
            <p class="text-gray-500 mt-2">Try a different category or search term</p>
        </div>

        <!-- Video Grid -->
        <div id="videoGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        </div>
    </main>

    <script>
        // Categories with search keywords for better live stream discovery
        const categories = [
            { id: 1, name: 'Film & Animation', keywords: 'film animation movie making behind scenes', icon: 'üé¨' },
            { id: 2, name: 'Autos & Vehicles', keywords: 'cars racing f1 nascar automotive vehicles driving', icon: 'üöó' },
            { id: 10, name: 'Music', keywords: 'music concert dj performance singing radio', icon: 'üéµ' },
            { id: 15, name: 'Pets & Animals', keywords: 'pets animals dogs cats wildlife zoo aquarium', icon: 'üêæ' },
            { id: 17, name: 'Sports', keywords: 'sports football basketball soccer nba nfl match game', icon: '‚öΩ' },
            { id: 18, name: 'Short Movies', keywords: 'short film indie movie festival', icon: 'üéûÔ∏è' },
            { id: 19, name: 'Travel & Events', keywords: 'travel vlog tour event walking city explore', icon: '‚úàÔ∏è' },
            { id: 20, name: 'Gaming', keywords: 'gaming gameplay gamer playing minecraft fortnite valorant', icon: 'üéÆ' },
            { id: 21, name: 'Videoblogging', keywords: 'vlog daily life vlogger irl', icon: 'üìπ' },
            { id: 22, name: 'People & Blogs', keywords: 'lifestyle blog daily vlog chat talk', icon: 'üë•' },
            { id: 23, name: 'Comedy', keywords: 'comedy funny standup humor jokes', icon: 'üòÇ' },
            { id: 24, name: 'Entertainment', keywords: 'entertainment show celebrity talk show podcast', icon: 'üé≠' },
            { id: 25, name: 'News & Politics', keywords: 'news politics breaking coverage world 24/7', icon: 'üì∞' },
            { id: 26, name: 'Howto & Style', keywords: 'tutorial howto fashion style makeup beauty diy', icon: 'üíÑ' },
            { id: 27, name: 'Education', keywords: 'education learning lecture class tutorial study', icon: 'üìö' },
            { id: 28, name: 'Science & Technology', keywords: 'technology science tech review coding programming AI', icon: 'üî¨' },
            { id: 29, name: 'Nonprofits & Activism', keywords: 'charity nonprofit activism awareness fundraiser', icon: 'üíö' },
            { id: 30, name: 'Movies', keywords: 'movies film cinema premiere reaction watch party', icon: 'üé•' },
            { id: 31, name: 'Anime/Animation', keywords: 'anime animation manga japanese vtuber', icon: 'üç•' },
            { id: 32, name: 'Action/Adventure', keywords: 'action adventure extreme sports stunts', icon: 'üí•' },
            { id: 33, name: 'Classics', keywords: 'classic vintage retro oldies nostalgia', icon: 'üìº' },
            { id: 34, name: 'Comedy (Film/TV)', keywords: 'comedy sitcom funny tv show reaction', icon: 'üì∫' },
            { id: 35, name: 'Documentary', keywords: 'documentary nature history real story earth', icon: 'üéûÔ∏è' },
            { id: 36, name: 'Drama', keywords: 'drama series tv show kdrama', icon: 'üé≠' },
            { id: 37, name: 'Family', keywords: 'family kids children friendly cartoon', icon: 'üë®‚Äçüë©‚Äçüëß' },
            { id: 38, name: 'Foreign', keywords: 'foreign international world language culture', icon: 'üåç' },
            { id: 39, name: 'Horror', keywords: 'horror scary ghost thriller paranormal', icon: 'üëª' },
            { id: 40, name: 'Sci-Fi/Fantasy', keywords: 'scifi fantasy space alien universe', icon: 'üöÄ' },
            { id: 41, name: 'Thriller', keywords: 'thriller suspense mystery crime detective', icon: 'üî™' },
            { id: 42, name: 'Shorts', keywords: 'shorts short video clip tiktok', icon: 'üì±' },
            { id: 43, name: 'Shows', keywords: 'show tv series episode broadcast channel', icon: 'üì°' },
            { id: 44, name: 'Trailers', keywords: 'trailer preview upcoming movie reaction', icon: 'üé¨' }
        ];

        // Multiple API Keys Management
        let apiKeys = JSON.parse(localStorage.getItem('youtube_api_keys') || '[]');
        let currentKeyIndex = parseInt(localStorage.getItem('youtube_current_key_index') || '0');
        let failedKeys = new Set(); // Track keys that failed in current session
        
        // Quota tracking per API key
        // YouTube API costs: search.list = 100 units, videos.list = 1 unit, channels.list = 1 unit
        // Daily quota limit is typically 10,000 units
        let apiQuotaUsage = JSON.parse(localStorage.getItem('youtube_api_quota_usage') || '{}');
        const DAILY_QUOTA_LIMIT = 10000;
        
        // Check if quota should be reset (new day)
        function checkQuotaReset() {
            const today = new Date().toDateString();
            const lastResetDate = localStorage.getItem('youtube_quota_reset_date');
            
            if (lastResetDate !== today) {
                // Reset all quota usage for new day
                apiQuotaUsage = {};
                localStorage.setItem('youtube_api_quota_usage', JSON.stringify(apiQuotaUsage));
                localStorage.setItem('youtube_quota_reset_date', today);
                failedKeys.clear();
            }
        }
        
        // Track quota usage for an API key
        function trackQuotaUsage(apiKey, endpoint) {
            const costs = {
                'search': 100,
                'videos': 1,
                'channels': 1
            };
            
            const cost = costs[endpoint] || 1;
            
            if (!apiQuotaUsage[apiKey]) {
                apiQuotaUsage[apiKey] = { used: 0, calls: { search: 0, videos: 0, channels: 0 }, lastUpdated: Date.now() };
            }
            
            apiQuotaUsage[apiKey].used += cost;
            apiQuotaUsage[apiKey].calls[endpoint] = (apiQuotaUsage[apiKey].calls[endpoint] || 0) + 1;
            apiQuotaUsage[apiKey].lastUpdated = Date.now();
            
            localStorage.setItem('youtube_api_quota_usage', JSON.stringify(apiQuotaUsage));
            
            // Update UI if modal is open
            updateQuotaDisplay();
        }
        
        // Get quota info for an API key
        function getQuotaInfo(apiKey) {
            const usage = apiQuotaUsage[apiKey] || { used: 0, calls: { search: 0, videos: 0, channels: 0 } };
            const percentage = Math.min((usage.used / DAILY_QUOTA_LIMIT) * 100, 100);
            const remaining = Math.max(DAILY_QUOTA_LIMIT - usage.used, 0);
            
            return {
                used: usage.used,
                remaining: remaining,
                percentage: percentage,
                calls: usage.calls,
                limit: DAILY_QUOTA_LIMIT
            };
        }
        
        // Update quota display in modal
        function updateQuotaDisplay() {
            const modal = document.getElementById('apiModal');
            if (modal.classList.contains('hidden')) return;
            
            apiKeys.forEach((key, index) => {
                const quotaBar = document.getElementById(`quota-bar-${index}`);
                const quotaText = document.getElementById(`quota-text-${index}`);
                
                if (quotaBar && quotaText) {
                    const info = getQuotaInfo(key);
                    quotaBar.style.width = `${info.percentage}%`;
                    quotaText.textContent = `${info.used.toLocaleString()} / ${info.limit.toLocaleString()}`;
                    
                    // Update color based on usage
                    quotaBar.className = quotaBar.className.replace(/bg-\w+-\d+/g, '');
                    if (info.percentage >= 90) {
                        quotaBar.classList.add('bg-red-500');
                    } else if (info.percentage >= 70) {
                        quotaBar.classList.add('bg-yellow-500');
                    } else {
                        quotaBar.classList.add('bg-green-500');
                    }
                }
            });
            
            // Update total stats
            updateTotalQuotaStats();
        }
        
        // Update total quota stats
        function updateTotalQuotaStats() {
            const totalStatsEl = document.getElementById('totalQuotaStats');
            if (!totalStatsEl) return;
            
            let totalUsed = 0;
            let totalCalls = { search: 0, videos: 0, channels: 0 };
            
            apiKeys.forEach(key => {
                const usage = apiQuotaUsage[key] || { used: 0, calls: { search: 0, videos: 0, channels: 0 } };
                totalUsed += usage.used;
                totalCalls.search += usage.calls?.search || 0;
                totalCalls.videos += usage.calls?.videos || 0;
                totalCalls.channels += usage.calls?.channels || 0;
            });
            
            totalStatsEl.innerHTML = `
                <div class="text-xs text-gray-400">
                    <span class="font-medium text-white">${totalUsed.toLocaleString()}</span> total units used today
                    <span class="text-gray-500 ml-2">|</span>
                    <span class="ml-2">üîç ${totalCalls.search}</span>
                    <span class="ml-2">üì∫ ${totalCalls.videos}</span>
                    <span class="ml-2">üì¢ ${totalCalls.channels}</span>
                </div>
            `;
        }
        
        let currentCategory = null;
        let currentSearch = '';
        let liveVideos = new Map();
        let refreshInterval = null;
        let countdownInterval = null;
        const REFRESH_TIME = 30; // seconds

        // Get current active API key
        function getActiveApiKey() {
            if (apiKeys.length === 0) return null;
            // Find next working key
            let attempts = 0;
            while (attempts < apiKeys.length) {
                if (!failedKeys.has(currentKeyIndex)) {
                    return apiKeys[currentKeyIndex];
                }
                currentKeyIndex = (currentKeyIndex + 1) % apiKeys.length;
                attempts++;
            }
            // All keys failed, reset and try again
            failedKeys.clear();
            return apiKeys[currentKeyIndex];
        }

        // Switch to next API key
        function switchToNextKey() {
            if (apiKeys.length <= 1) return false;
            
            failedKeys.add(currentKeyIndex);
            const previousIndex = currentKeyIndex;
            currentKeyIndex = (currentKeyIndex + 1) % apiKeys.length;
            
            // Check if we've tried all keys
            if (failedKeys.size >= apiKeys.length) {
                // Reset after a delay (quota resets)
                setTimeout(() => failedKeys.clear(), 60000);
                return false;
            }
            
            localStorage.setItem('youtube_current_key_index', currentKeyIndex.toString());
            updateApiStatus();
            console.log(`Switched from API key ${previousIndex + 1} to ${currentKeyIndex + 1}`);
            return true;
        }

        // Update API status indicator
        function updateApiStatus() {
            const statusEl = document.getElementById('apiStatusBtn');
            const statusText = document.getElementById('apiStatusText');
            
            if (apiKeys.length > 0) {
                statusEl.classList.remove('hidden');
                statusEl.classList.add('flex');
                
                const indicator = statusEl.querySelector('span:first-child');
                
                if (failedKeys.size === 0) {
                    statusEl.className = statusEl.className.replace(/bg-\w+-\d+\/\d+/g, '').trim() + ' bg-green-600/20';
                    indicator.className = 'w-2 h-2 rounded-full bg-green-500';
                } else if (failedKeys.size < apiKeys.length) {
                    statusEl.className = statusEl.className.replace(/bg-\w+-\d+\/\d+/g, '').trim() + ' bg-yellow-600/20';
                    indicator.className = 'w-2 h-2 rounded-full bg-yellow-500';
                } else {
                    statusEl.className = statusEl.className.replace(/bg-\w+-\d+\/\d+/g, '').trim() + ' bg-red-600/20';
                    indicator.className = 'w-2 h-2 rounded-full bg-red-500';
                }
                
                statusText.textContent = `API ${currentKeyIndex + 1}/${apiKeys.length}`;
            } else {
                statusEl.classList.add('hidden');
            }
        }

        // API fetch with auto-switch on quota exceeded
        async function fetchWithApiSwitch(url, retryCount = 0) {
            const apiKey = getActiveApiKey();
            if (!apiKey) {
                throw new Error('No API keys available. Please add at least one API key.');
            }
            
            const fullUrl = url.replace('{API_KEY}', apiKey);
            
            // Determine endpoint type for quota tracking
            let endpoint = 'videos';
            if (url.includes('/search')) {
                endpoint = 'search';
            } else if (url.includes('/channels')) {
                endpoint = 'channels';
            } else if (url.includes('/videos')) {
                endpoint = 'videos';
            }
            
            try {
                const response = await fetch(fullUrl);
                const data = await response.json();
                
                if (data.error) {
                    const errorCode = data.error.errors?.[0]?.reason;
                    const errorMessage = data.error.message;
                    
                    // Check for quota exceeded or rate limit errors
                    if (errorCode === 'quotaExceeded' || 
                        errorCode === 'rateLimitExceeded' || 
                        errorCode === 'dailyLimitExceeded' ||
                        errorMessage.includes('quota') ||
                        errorMessage.includes('limit')) {
                        
                        // Mark this key as quota exceeded
                        if (apiQuotaUsage[apiKey]) {
                            apiQuotaUsage[apiKey].used = DAILY_QUOTA_LIMIT;
                            localStorage.setItem('youtube_api_quota_usage', JSON.stringify(apiQuotaUsage));
                            updateQuotaDisplay();
                        }
                        
                        console.warn(`API key ${currentKeyIndex + 1} quota exceeded, switching...`);
                        showToast(`API key ${currentKeyIndex + 1} quota exceeded, switching to next key...`, 'warning');
                        
                        if (switchToNextKey() && retryCount < apiKeys.length) {
                            return fetchWithApiSwitch(url, retryCount + 1);
                        }
                    }
                    
                    throw new Error(errorMessage);
                }
                
                // Track successful API call quota usage
                trackQuotaUsage(apiKey, endpoint);
                
                return data;
                
            } catch (error) {
                if (error.message.includes('quota') || error.message.includes('limit')) {
                    if (switchToNextKey() && retryCount < apiKeys.length) {
                        return fetchWithApiSwitch(url, retryCount + 1);
                    }
                }
                throw error;
            }
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'warning' ? 'bg-yellow-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            toast.className = `fixed bottom-20 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm animate-fade-in`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Reset quota stats (for testing/debugging)
        function resetQuotaStats() {
            if (confirm('Reset all quota tracking stats? This only resets the local tracking, not the actual YouTube quota.')) {
                apiQuotaUsage = {};
                localStorage.setItem('youtube_api_quota_usage', JSON.stringify(apiQuotaUsage));
                renderApiKeysList();
                updateTotalQuotaStats();
                showToast('Quota stats reset successfully', 'info');
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check if quota should be reset (new day)
            checkQuotaReset();
            
            renderCategories();
            renderApiKeysList();
            
            if (apiKeys.length > 0) {
                hasStartedWatching = true;
                document.getElementById('apiModal').classList.add('hidden');
                document.getElementById('apiSettingsBtn').classList.remove('hidden');
                document.getElementById('apiSettingsBtn').classList.add('flex');
                updateApiStatus();
                loadLiveStreams();
                startAutoRefresh();
            }

            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchVideos();
            });
            
            document.getElementById('apiKeyInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addApiKey();
            });
        });

        // Track key validation status
        let keyValidationStatus = {}; // { key: 'valid' | 'invalid' | 'quota' | 'pending' }

        // Render API keys list in modal
        function renderApiKeysList() {
            const listEl = document.getElementById('apiKeysList');
            const countEl = document.getElementById('keyCount');
            const warningEl = document.getElementById('quotaWarning');
            const startBtn = document.getElementById('startButton');
            const validateAllBtn = document.getElementById('validateAllBtn');
            
            listEl.innerHTML = apiKeys.map((key, index) => {
                const status = keyValidationStatus[key] || 'unknown';
                const quotaInfo = getQuotaInfo(key);
                let statusIcon = '';
                let statusClass = 'bg-gray-600';
                
                if (status === 'valid') {
                    statusIcon = '<svg class="w-3 h-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
                    statusClass = 'bg-green-600';
                } else if (status === 'invalid') {
                    statusIcon = '<svg class="w-3 h-3 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
                    statusClass = 'bg-red-600';
                } else if (status === 'quota') {
                    statusIcon = '<svg class="w-3 h-3 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01"/></svg>';
                    statusClass = 'bg-yellow-600';
                } else if (status === 'pending') {
                    statusIcon = '<svg class="w-3 h-3 text-blue-400 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>';
                    statusClass = 'bg-blue-600';
                }
                
                // Determine quota bar color
                let quotaBarColor = 'bg-green-500';
                if (quotaInfo.percentage >= 90) {
                    quotaBarColor = 'bg-red-500';
                } else if (quotaInfo.percentage >= 70) {
                    quotaBarColor = 'bg-yellow-500';
                }
                
                // Check if this is the active key
                const isActive = index === currentKeyIndex;
                
                return `
                <div class="p-3 bg-gray-700 rounded-lg group ${isActive ? 'ring-2 ring-blue-500' : ''}" data-key-index="${index}">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-6 h-6 flex items-center justify-center text-xs font-bold rounded-full ${statusClass}" title="${status}">
                            ${statusIcon || (index + 1)}
                        </span>
                        <span class="flex-1 font-mono text-sm text-gray-300 truncate">${key.substring(0, 8)}...${key.substring(key.length - 4)}</span>
                        ${isActive ? '<span class="text-xs bg-blue-600 text-white px-2 py-0.5 rounded-full">Active</span>' : ''}
                        <span class="text-xs text-gray-500 capitalize ${status === 'unknown' ? 'hidden' : ''}">${status}</span>
                        <button onclick="removeApiKey(${index})" class="p-1 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition" title="Remove key">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <!-- Quota Usage Bar -->
                    <div class="mt-2">
                        <div class="flex items-center justify-between text-xs text-gray-400 mb-1">
                            <span>Quota Used</span>
                            <span id="quota-text-${index}">${quotaInfo.used.toLocaleString()} / ${quotaInfo.limit.toLocaleString()}</span>
                        </div>
                        <div class="h-2 bg-gray-600 rounded-full overflow-hidden">
                            <div id="quota-bar-${index}" class="h-full ${quotaBarColor} transition-all duration-300" style="width: ${quotaInfo.percentage}%"></div>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500 mt-1">
                            <span>üîç ${quotaInfo.calls?.search || 0} searches</span>
                            <span>üì∫ ${quotaInfo.calls?.videos || 0} videos</span>
                            <span>üì¢ ${quotaInfo.calls?.channels || 0} channels</span>
                        </div>
                    </div>
                </div>
            `}).join('');
            
            countEl.textContent = apiKeys.length;
            warningEl.style.display = apiKeys.length > 1 ? 'inline' : 'none';
            
            // Count valid keys
            const validKeys = apiKeys.filter(key => keyValidationStatus[key] === 'valid' || keyValidationStatus[key] === 'quota').length;
            const hasUnknownKeys = apiKeys.some(key => !keyValidationStatus[key] || keyValidationStatus[key] === 'unknown');
            
            // Show validate all button if there are keys without validation status
            if (apiKeys.length > 0 && hasUnknownKeys) {
                validateAllBtn.classList.remove('hidden');
                validateAllBtn.classList.add('flex');
            } else {
                validateAllBtn.classList.add('hidden');
                validateAllBtn.classList.remove('flex');
            }
            
            // Enable start button only if there's at least one valid key or all keys are unvalidated (first time)
            const allUnknown = apiKeys.every(key => !keyValidationStatus[key] || keyValidationStatus[key] === 'unknown');
            startBtn.disabled = apiKeys.length === 0 || (!allUnknown && validKeys === 0);
        }

        // Validate all keys
        async function validateAllKeys() {
            const validateBtn = document.getElementById('validateAllBtn');
            const validateText = document.getElementById('validateAllText');
            
            validateBtn.disabled = true;
            validateText.textContent = 'Validating...';
            
            for (let i = 0; i < apiKeys.length; i++) {
                const key = apiKeys[i];
                keyValidationStatus[key] = 'pending';
                renderApiKeysList();
                
                const result = await validateApiKey(key);
                
                if (result.valid) {
                    keyValidationStatus[key] = result.warning ? 'quota' : 'valid';
                } else {
                    keyValidationStatus[key] = 'invalid';
                }
                
                renderApiKeysList();
                
                // Small delay between validations
                if (i < apiKeys.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }
            
            validateBtn.disabled = false;
            validateText.textContent = 'Validate All Keys';
            
            // Show summary
            const validCount = apiKeys.filter(key => keyValidationStatus[key] === 'valid').length;
            const quotaCount = apiKeys.filter(key => keyValidationStatus[key] === 'quota').length;
            const invalidCount = apiKeys.filter(key => keyValidationStatus[key] === 'invalid').length;
            
            if (invalidCount > 0) {
                showValidationStatus('warning', `${validCount} valid, ${quotaCount} quota exceeded, ${invalidCount} invalid`);
            } else if (quotaCount > 0) {
                showValidationStatus('warning', `${validCount} valid, ${quotaCount} with quota exceeded`);
            } else {
                showValidationStatus('success', `All ${validCount} keys are valid!`);
            }
        }

        // Validate API key
        async function validateApiKey(key) {
            try {
                // Make a simple API call to check if the key is valid
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=1&q=test&key=${key}`);
                const data = await response.json();
                
                if (data.error) {
                    const errorReason = data.error.errors?.[0]?.reason || 'unknown';
                    const errorMessage = data.error.message || 'Invalid API key';
                    
                    if (errorReason === 'keyInvalid' || errorMessage.includes('API key not valid')) {
                        return { valid: false, message: 'Invalid API key. Please check and try again.' };
                    } else if (errorReason === 'accessNotConfigured') {
                        return { valid: false, message: 'YouTube Data API v3 is not enabled for this key. Enable it in Google Cloud Console.' };
                    } else if (errorReason === 'quotaExceeded' || errorReason === 'dailyLimitExceeded') {
                        return { valid: true, message: 'Valid key but quota exceeded. You can still add it for rotation.', warning: true };
                    } else if (errorReason === 'ipRefererBlocked') {
                        return { valid: false, message: 'API key has IP/domain restrictions that block this site.' };
                    } else {
                        return { valid: false, message: errorMessage };
                    }
                }
                
                return { valid: true, message: 'API key is valid!' };
                
            } catch (error) {
                return { valid: false, message: 'Network error. Please check your connection.' };
            }
        }

        // Show validation status
        function showValidationStatus(type, message) {
            const container = document.getElementById('validationStatus');
            const icon = document.getElementById('validationIcon');
            const msg = document.getElementById('validationMessage');
            
            container.classList.remove('hidden', 'bg-green-900/50', 'bg-red-900/50', 'bg-yellow-900/50');
            
            if (type === 'success') {
                container.classList.add('bg-green-900/50');
                icon.innerHTML = '<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
            } else if (type === 'error') {
                container.classList.add('bg-red-900/50');
                icon.innerHTML = '<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
            } else if (type === 'warning') {
                container.classList.add('bg-yellow-900/50');
                icon.innerHTML = '<svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>';
            }
            
            msg.textContent = message;
        }

        // Hide validation status
        function hideValidationStatus() {
            document.getElementById('validationStatus').classList.add('hidden');
        }

        // Add new API key with validation
        async function addApiKey() {
            const input = document.getElementById('apiKeyInput');
            const addBtn = document.getElementById('addKeyBtn');
            const addText = document.getElementById('addKeyText');
            const spinner = document.getElementById('addKeySpinner');
            const key = input.value.trim();
            
            if (!key) {
                showValidationStatus('error', 'Please enter an API key');
                return;
            }
            
            if (apiKeys.includes(key)) {
                showValidationStatus('warning', 'This API key is already added');
                return;
            }
            
            // Show loading state
            addBtn.disabled = true;
            addText.textContent = 'Validating...';
            spinner.classList.remove('hidden');
            hideValidationStatus();
            
            try {
                const result = await validateApiKey(key);
                
                if (result.valid) {
                    apiKeys.push(key);
                    keyValidationStatus[key] = result.warning ? 'quota' : 'valid';
                    localStorage.setItem('youtube_api_keys', JSON.stringify(apiKeys));
                    input.value = '';
                    renderApiKeysList();
                    updateApiStatus();
                    
                    if (result.warning) {
                        showValidationStatus('warning', result.message);
                    } else {
                        showValidationStatus('success', result.message);
                    }
                    
                    // Auto-hide success message after 3 seconds
                    setTimeout(hideValidationStatus, 3000);
                } else {
                    showValidationStatus('error', result.message);
                }
            } catch (error) {
                showValidationStatus('error', 'Failed to validate API key');
            } finally {
                // Reset button state
                addBtn.disabled = false;
                addText.textContent = '+ Add';
                spinner.classList.add('hidden');
            }
        }

        // Remove API key
        function removeApiKey(index) {
            const removedKey = apiKeys[index];
            apiKeys.splice(index, 1);
            
            // Remove validation status for the removed key
            if (removedKey && keyValidationStatus[removedKey]) {
                delete keyValidationStatus[removedKey];
            }
            
            if (currentKeyIndex >= apiKeys.length) {
                currentKeyIndex = Math.max(0, apiKeys.length - 1);
            }
            localStorage.setItem('youtube_api_keys', JSON.stringify(apiKeys));
            localStorage.setItem('youtube_current_key_index', currentKeyIndex.toString());
            renderApiKeysList();
            updateApiStatus();
            hideValidationStatus();
        }

        // Start with keys (validates first if not already validated)
        async function startWithKeys() {
            if (apiKeys.length === 0) return;
            
            const startBtn = document.getElementById('startButton');
            const startText = document.getElementById('startButtonText');
            const startSpinner = document.getElementById('startSpinner');
            
            // Check if any keys need validation
            const hasUnvalidatedKeys = apiKeys.some(key => !keyValidationStatus[key] || keyValidationStatus[key] === 'unknown');
            
            if (hasUnvalidatedKeys) {
                startBtn.disabled = true;
                startText.textContent = 'Validating keys...';
                startSpinner.classList.remove('hidden');
                hideValidationStatus();
                
                // Validate all keys first
                let hasValidKey = false;
                
                for (let i = 0; i < apiKeys.length; i++) {
                    const key = apiKeys[i];
                    keyValidationStatus[key] = 'pending';
                    renderApiKeysList();
                    
                    const result = await validateApiKey(key);
                    
                    if (result.valid) {
                        keyValidationStatus[key] = result.warning ? 'quota' : 'valid';
                        if (!result.warning) hasValidKey = true;
                    } else {
                        keyValidationStatus[key] = 'invalid';
                    }
                    
                    renderApiKeysList();
                    
                    if (i < apiKeys.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
                
                startBtn.disabled = false;
                startText.textContent = 'Start Watching Live';
                startSpinner.classList.add('hidden');
                
                // Check if we have any valid keys
                const validKeys = apiKeys.filter(key => keyValidationStatus[key] === 'valid' || keyValidationStatus[key] === 'quota');
                
                if (validKeys.length === 0) {
                    showValidationStatus('error', 'No valid API keys found. Please add a valid key.');
                    return;
                }
                
                // Set current key index to first valid key
                const firstValidIndex = apiKeys.findIndex(key => keyValidationStatus[key] === 'valid' || keyValidationStatus[key] === 'quota');
                if (firstValidIndex !== -1) {
                    currentKeyIndex = firstValidIndex;
                    localStorage.setItem('youtube_current_key_index', currentKeyIndex.toString());
                }
                
                showValidationStatus('success', `${validKeys.length} valid key(s) found. Starting...`);
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            hasStartedWatching = true;
            document.getElementById('apiModal').classList.add('hidden');
            document.getElementById('apiSettingsBtn').classList.remove('hidden');
            document.getElementById('apiSettingsBtn').classList.add('flex');
            updateApiStatus();
            loadLiveStreams();
            startAutoRefresh();
        }

        // Track if user has started watching (to show Done vs Start button)
        let hasStartedWatching = false;
        
        // Open API settings modal
        function openApiSettings() {
            const modal = document.getElementById('apiModal');
            const modalTitle = document.getElementById('modalTitle');
            const closeBtn = document.getElementById('modalCloseBtn');
            const startBtn = document.getElementById('startButton');
            const doneBtn = document.getElementById('doneButton');
            
            // Check for quota reset before showing
            checkQuotaReset();
            
            modal.classList.remove('hidden');
            renderApiKeysList();
            updateTotalQuotaStats();
            
            if (hasStartedWatching) {
                // Returning user - show close button and done button
                modalTitle.textContent = 'Manage API Keys';
                closeBtn.classList.remove('hidden');
                doneBtn.classList.remove('hidden');
                doneBtn.classList.add('flex');
                startBtn.classList.add('hidden');
                startBtn.classList.remove('flex');
            } else {
                // First time - show start button
                modalTitle.textContent = 'Welcome to LiveTube';
                closeBtn.classList.add('hidden');
                doneBtn.classList.add('hidden');
                doneBtn.classList.remove('flex');
                startBtn.classList.remove('hidden');
                startBtn.classList.add('flex');
            }
        }
        
        // Close API modal
        function closeApiModal() {
            document.getElementById('apiModal').classList.add('hidden');
            hideValidationStatus();
        }

        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'category-btn whitespace-nowrap px-4 py-2 bg-gray-700 rounded-full text-sm hover:bg-gray-600 transition flex-shrink-0';
                btn.textContent = `${cat.icon} ${cat.name}`;
                btn.onclick = () => selectCategory(cat.id);
                btn.dataset.categoryId = cat.id;
                container.appendChild(btn);
            });
            
            // Setup scroll arrows visibility
            updateScrollArrows();
            container.addEventListener('scroll', updateScrollArrows);
            
            // Setup drag to scroll
            setupDragToScroll(container);
        }
        
        function scrollCategories(amount) {
            const container = document.getElementById('categoriesContainer');
            container.scrollBy({ left: amount, behavior: 'smooth' });
        }
        
        function updateScrollArrows() {
            const container = document.getElementById('categoriesContainer');
            const leftBtn = document.getElementById('scrollLeftBtn');
            const rightBtn = document.getElementById('scrollRightBtn');
            const leftFade = document.getElementById('leftFade');
            const rightFade = document.getElementById('rightFade');
            
            const canScrollLeft = container.scrollLeft > 10;
            const canScrollRight = container.scrollLeft < container.scrollWidth - container.clientWidth - 10;
            
            // Show/hide left arrow and fade
            if (canScrollLeft) {
                leftBtn.classList.remove('opacity-0', 'invisible');
                leftBtn.classList.add('opacity-100', 'visible');
                leftFade.classList.add('opacity-100');
                leftFade.classList.remove('opacity-0');
            } else {
                leftBtn.classList.add('opacity-0', 'invisible');
                leftBtn.classList.remove('opacity-100', 'visible');
                leftFade.classList.remove('opacity-100');
                leftFade.classList.add('opacity-0');
            }
            
            // Show/hide right arrow and fade
            if (canScrollRight) {
                rightBtn.classList.remove('opacity-0', 'invisible');
                rightBtn.classList.add('opacity-100', 'visible');
                rightFade.classList.add('opacity-100');
                rightFade.classList.remove('opacity-0');
            } else {
                rightBtn.classList.add('opacity-0', 'invisible');
                rightBtn.classList.remove('opacity-100', 'visible');
                rightFade.classList.remove('opacity-100');
                rightFade.classList.add('opacity-0');
            }
        }
        
        function setupDragToScroll(container) {
            let isDown = false;
            let startX;
            let scrollLeft;
            
            container.addEventListener('mousedown', (e) => {
                isDown = true;
                container.style.cursor = 'grabbing';
                startX = e.pageX - container.offsetLeft;
                scrollLeft = container.scrollLeft;
            });
            
            container.addEventListener('mouseleave', () => {
                isDown = false;
                container.style.cursor = 'grab';
            });
            
            container.addEventListener('mouseup', () => {
                isDown = false;
                container.style.cursor = 'grab';
            });
            
            container.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - container.offsetLeft;
                const walk = (x - startX) * 2;
                container.scrollLeft = scrollLeft - walk;
            });
            
            // Set initial cursor
            container.style.cursor = 'grab';
        }

        function getSelectedCategoryName() {
            if (!currentCategory) return 'All Live';
            const category = categories.find(c => c.id === currentCategory);
            return category ? category.name : 'All Live';
        }

        function selectCategory(categoryId) {
            currentCategory = categoryId;
            currentSearch = ''; // Clear search when changing category
            document.getElementById('searchInput').value = ''; // Clear search input
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                const btnCatId = btn.dataset.categoryId;
                if ((categoryId === null && !btnCatId) || 
                    (btnCatId && parseInt(btnCatId) === categoryId)) {
                    btn.classList.add('active');
                }
            });
            
            // Update category title
            const category = categories.find(c => c.id === categoryId);
            const categoryName = category ? `${category.icon} ${category.name}` : 'üî¥ All Live';
            document.getElementById('categoryTitle').textContent = categoryId ? `${categoryName} - Live Streams` : 'All Live Streams';
            
            loadLiveStreams();
        }

        function searchVideos() {
            currentSearch = document.getElementById('searchInput').value.trim();
            loadLiveStreams();
        }

        async function loadLiveStreams() {
            showLoading(true);
            hideError();
            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('videoGrid').innerHTML = '';

            try {
                let searchQueries = [];
                
                // If user typed a search, use it
                if (currentSearch) {
                    searchQueries = [currentSearch + ' live'];
                } 
                // If category is selected, use its keywords
                else if (currentCategory) {
                    const category = categories.find(c => c.id === currentCategory);
                    if (category && category.keywords) {
                        // Split keywords and create multiple search queries for better results
                        const keywordParts = category.keywords.split(' ');
                        searchQueries = [
                            category.keywords + ' live',
                            category.name + ' live stream',
                            keywordParts[0] + ' live streaming'
                        ];
                    }
                } 
                // For "All Live", search multiple popular terms to get diverse results
                else {
                    searchQueries = [
                        'live stream',
                        'live now',
                        'streaming live',
                        'live gaming',
                        'live music',
                        'live news',
                        'live sports',
                        'live entertainment'
                    ];
                }

                let allItems = [];
                const seenIds = new Set();

                // Fetch results for each search query
                for (const query of searchQueries) {
                    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&eventType=live&maxResults=25&order=viewCount&key={API_KEY}&q=${encodeURIComponent(query)}`;
                    
                    const data = await fetchWithApiSwitch(url);

                    if (data.items) {
                        data.items.forEach(item => {
                            if (!seenIds.has(item.id.videoId)) {
                                seenIds.add(item.id.videoId);
                                allItems.push(item);
                            }
                        });
                    }
                    
                    // Small delay to avoid rate limiting
                    if (searchQueries.length > 1) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                if (allItems.length === 0) {
                    document.getElementById('noResults').classList.remove('hidden');
                    document.getElementById('videoGrid').innerHTML = '';
                    document.getElementById('liveCount').classList.add('hidden');
                    showLoading(false);
                    return;
                }

                // Get video IDs for detailed info (batch in groups of 50)
                const videoIds = allItems.map(item => item.id.videoId).slice(0, 50).join(',');
                const detailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,liveStreamingDetails,statistics&id=${videoIds}&key={API_KEY}`;
                
                const detailsData = await fetchWithApiSwitch(detailsUrl);

                // Filter only currently live videos
                let liveItems = detailsData.items ? detailsData.items.filter(video => 
                    video.snippet.liveBroadcastContent === 'live'
                ) : [];

                // Sort by viewer count (highest first)
                liveItems.sort((a, b) => {
                    const viewersA = parseInt(a.liveStreamingDetails?.concurrentViewers || 0);
                    const viewersB = parseInt(b.liveStreamingDetails?.concurrentViewers || 0);
                    return viewersB - viewersA;
                });

                // Update our tracking map
                const newLiveVideos = new Map();
                liveItems.forEach(video => {
                    newLiveVideos.set(video.id, video);
                });

                // Find videos that ended
                liveVideos.forEach((video, id) => {
                    if (!newLiveVideos.has(id)) {
                        removeVideoCard(id);
                    }
                });

                liveVideos = newLiveVideos;
                renderVideos(liveItems);

            } catch (error) {
                showError(error.message);
            }

            showLoading(false);
        }

        function renderVideos(videos) {
            const grid = document.getElementById('videoGrid');
            const liveCountEl = document.getElementById('liveCount');
            
            if (videos.length === 0) {
                grid.innerHTML = '';
                document.getElementById('noResults').classList.remove('hidden');
                liveCountEl.classList.add('hidden');
                return;
            }

            document.getElementById('noResults').classList.add('hidden');
            liveCountEl.textContent = `${videos.length} live`;
            liveCountEl.classList.remove('hidden');
            grid.innerHTML = videos.map(video => createVideoCard(video)).join('');
        }

        function createVideoCard(video) {
            const thumbnail = video.snippet.thumbnails.high?.url || video.snippet.thumbnails.medium?.url || video.snippet.thumbnails.default?.url;
            const title = video.snippet.title;
            const channel = video.snippet.channelTitle;
            const viewers = video.liveStreamingDetails?.concurrentViewers || '0';
            const viewerCount = formatNumber(viewers);

            return `
                <div class="video-card bg-gray-800 rounded-xl overflow-hidden hover:bg-gray-750 transition cursor-pointer group" 
                     data-video-id="${video.id}" onclick="playVideo('${video.id}')">
                    <div class="relative thumbnail-hover">
                        <img src="${thumbnail}" alt="${escapeHtml(title)}" class="w-full aspect-video object-cover">
                        <div class="absolute top-2 left-2 bg-red-600 text-white text-xs px-2 py-1 rounded flex items-center gap-1 live-badge">
                            <span class="w-2 h-2 bg-white rounded-full"></span>
                            LIVE
                        </div>
                        <div class="absolute bottom-2 right-2 bg-black/80 text-white text-xs px-2 py-1 rounded">
                            ${viewerCount} watching
                        </div>
                        <div class="play-overlay absolute inset-0 bg-black/50 flex items-center justify-center">
                            <div class="w-16 h-16 bg-red-600/90 rounded-full flex items-center justify-center">
                                <svg class="w-8 h-8 ml-1" fill="white" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="font-medium line-clamp-2 mb-2 group-hover:text-red-400 transition">${escapeHtml(title)}</h3>
                        <p class="text-sm text-gray-400">${escapeHtml(channel)}</p>
                    </div>
                </div>
            `;
        }

        function removeVideoCard(videoId) {
            const card = document.querySelector(`[data-video-id="${videoId}"]`);
            if (card) {
                card.style.transition = 'all 0.5s ease-out';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.8)';
                setTimeout(() => card.remove(), 500);
            }
        }

        async function playVideo(videoId) {
            const modal = document.getElementById('playerModal');
            const player = document.getElementById('videoPlayer');
            const chatFrame = document.getElementById('liveChatFrame');
            const chatUnavailable = document.getElementById('chatUnavailable');
            const chatContainer = document.getElementById('chatContainer');
            
            // Set video player
            player.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
            
            // Set live chat - get the current domain for embed
            const embedDomain = window.location.hostname || 'localhost';
            const chatUrl = `https://www.youtube.com/live_chat?v=${videoId}&embed_domain=${embedDomain}`;
            chatFrame.src = chatUrl;
            
            // Set YouTube links
            document.getElementById('watchOnYoutube').href = `https://www.youtube.com/watch?v=${videoId}`;
            document.getElementById('chatYoutubeLink').href = `https://www.youtube.com/live_chat?v=${videoId}`;
            
            // Reset chat visibility
            chatFrame.classList.remove('hidden');
            chatUnavailable.classList.add('hidden');
            document.getElementById('chatToggleBtn').textContent = 'Hide';
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Get video details
            try {
                const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,liveStreamingDetails,statistics&id=${videoId}&key={API_KEY}`;
                const data = await fetchWithApiSwitch(url);
                
                if (data.items && data.items.length > 0) {
                    const video = data.items[0];
                    
                    // Check if still live
                    if (video.snippet.liveBroadcastContent !== 'live') {
                        closePlayer();
                        showToast('This stream has ended!', 'warning');
                        loadLiveStreams();
                        return;
                    }

                    document.getElementById('playerTitle').textContent = video.snippet.title;
                    document.getElementById('channelName').textContent = video.snippet.channelTitle;
                    document.getElementById('viewerCount').textContent = `${formatNumber(video.liveStreamingDetails?.concurrentViewers || 0)} watching now`;
                    document.getElementById('videoDescription').textContent = video.snippet.description;
                    
                    // Check if live chat is enabled
                    const chatEnabled = video.liveStreamingDetails?.activeLiveChatId ? true : false;
                    if (!chatEnabled) {
                        // Chat might still work, but show fallback option
                        console.log('Live chat ID not found, chat may be disabled');
                    }
                    
                    // Get channel thumbnail
                    const channelUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${video.snippet.channelId}&key={API_KEY}`;
                    const channelData = await fetchWithApiSwitch(channelUrl);
                    if (channelData.items && channelData.items.length > 0) {
                        document.getElementById('channelThumbnail').src = channelData.items[0].snippet.thumbnails.default.url;
                    }
                }
            } catch (error) {
                console.error('Error loading video details:', error);
            }
            
            // Handle chat iframe load error
            chatFrame.onerror = () => {
                chatFrame.classList.add('hidden');
                chatUnavailable.classList.remove('hidden');
            };
        }
        
        // Toggle chat visibility
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            const chatToggleBtn = document.getElementById('chatToggleBtn');
            
            if (chatContainer.classList.contains('hidden')) {
                chatContainer.classList.remove('hidden');
                chatToggleBtn.textContent = 'Hide';
            } else {
                chatContainer.classList.add('hidden');
                chatToggleBtn.textContent = 'Show';
            }
        }

        function closePlayer() {
            const modal = document.getElementById('playerModal');
            const player = document.getElementById('videoPlayer');
            const chatFrame = document.getElementById('liveChatFrame');
            
            // Clear video and chat
            player.src = '';
            chatFrame.src = '';
            
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function startAutoRefresh() {
            document.getElementById('refreshStatus').classList.remove('hidden');
            let countdown = REFRESH_TIME;
            
            countdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('countdown').textContent = countdown;
                if (countdown <= 0) {
                    countdown = REFRESH_TIME;
                }
            }, 1000);

            refreshInterval = setInterval(() => {
                checkLiveStatus();
            }, REFRESH_TIME * 1000);
        }

        async function checkLiveStatus() {
            if (liveVideos.size === 0) {
                loadLiveStreams();
                return;
            }

            const videoIds = Array.from(liveVideos.keys()).join(',');
            try {
                const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,liveStreamingDetails&id=${videoIds}&key={API_KEY}`;
                const data = await fetchWithApiSwitch(url);

                if (data.items) {
                    const stillLive = new Set();
                    data.items.forEach(video => {
                        if (video.snippet.liveBroadcastContent === 'live') {
                            stillLive.add(video.id);
                            // Update viewer count
                            const card = document.querySelector(`[data-video-id="${video.id}"]`);
                            if (card) {
                                const viewerBadge = card.querySelector('.absolute.bottom-2.right-2');
                                if (viewerBadge && video.liveStreamingDetails?.concurrentViewers) {
                                    viewerBadge.textContent = `${formatNumber(video.liveStreamingDetails.concurrentViewers)} watching`;
                                }
                            }
                        }
                    });

                    // Remove ended streams
                    liveVideos.forEach((video, id) => {
                        if (!stillLive.has(id)) {
                            removeVideoCard(id);
                            liveVideos.delete(id);
                        }
                    });
                    
                    // Update live count
                    const liveCountEl = document.getElementById('liveCount');
                    liveCountEl.textContent = `${liveVideos.size} live`;
                }

                // Reload if no videos left
                if (liveVideos.size === 0) {
                    loadLiveStreams();
                }

            } catch (error) {
                console.error('Error checking live status:', error);
            }
        }

        function showLoading(show, message = null) {
            document.getElementById('loading').classList.toggle('hidden', !show);
            if (message) {
                document.getElementById('loadingText').textContent = message;
            } else if (currentCategory) {
                const category = categories.find(c => c.id === currentCategory);
                document.getElementById('loadingText').textContent = `Searching for ${category ? category.name : ''} live streams...`;
            } else if (currentSearch) {
                document.getElementById('loadingText').textContent = `Searching for "${currentSearch}" live streams...`;
            } else {
                document.getElementById('loadingText').textContent = 'Searching for live streams...';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function formatNumber(num) {
            num = parseInt(num);
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePlayer();
            }
        });

        // Close modal on outside click
        document.getElementById('playerModal').addEventListener('click', (e) => {
            if (e.target.id === 'playerModal') {
                closePlayer();
            }
        });
    </script>
</body>
</html>
